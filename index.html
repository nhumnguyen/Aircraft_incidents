<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3-legend/1.1.0/d3-legend.js"></script>
<style type="text/css">

/* On mouse hover, lighten state color */
path:hover {
	fill-opacity: .7;
}

/* Style for Custom Tooltip */
div.tooltip {
 	position: absolute;
	text-align: center;
	width: 200px;
	height: 100px;
	padding: 2px;
	font: 12px sans-serif;
	background: white;
	border: 0px;
	border-radius: 8px;
	pointer-events: none;


}

/* Legend Font Style */
body {
	font: 11px sans-serif;
}

/* Legend Position Style */
.legend {
	position:absolute;
	left:800px;
	top:350px;
}

</style>
</head>
<body>
	<form>
  <label><input type="radio" name="state" value="GA"  checked> GA</label>
  <label><input type="radio" name="state" value="KY" > KY</label>
</form>
<script type="text/javascript">


//Width and height of map
var width = 960;
var height = 500;

// D3 Projection
var projection = d3.geo.albersUsa()
				   .translate([width/2, height/2])    // translate to center of screen
				   .scale([1000]);          // scale things down so see entire US

// Define path generator
var path = d3.geo.path()               // path generator that will convert GeoJSON to SVG paths
		  	 .projection(projection);  // tell path generator to use albersUsa projection


// Define linear scale for output
var color = d3.scale.linear()
			  .range(["rgb(213,222,217)","rgb(69,173,168)","rgb(84,36,55)","rgb(217,91,67)"]);

var legendText = ["Cities Lived", "States Lived", "States Visited", "Nada"];

//Create SVG element and append map to the SVG
var svg = d3.select("body")
			.append("svg")
			.attr("width", width)
			.attr("height", height);

// Append Div for tooltip to SVG
var ttdiv = d3.select("body")
		    .append("div")
    		.attr("class", "tooltip")
    		.style("opacity", 1);


var ttheader = ttdiv.append("p")
								.attr("class", "ttheader")
								.style("fill", "red");


	// Load GeoJSON data and merge with states data
d3.json("us-states.json", function(json) {
			// Find the corresponding state inside the GeoJSON
			for (var j = 0; j < json.features.length; j++)  {
								var jsonState = json.features[j].properties.name;
			}

			// Bind the data to the SVG and create one path per GeoJSON feature
			svg.selectAll("path")
				.data(json.features)
				.enter()
				.append("path")
				.attr("d", path)
				.style("stroke", "#fff")
				.style("stroke-width", "1")
				.style("fill", "black");
				// .on("click", clicked);


d3.csv("aircraft_incidents.csv", function(data) {

			svg.selectAll("circle")
				.data(data)
				.enter()
				.append("circle")
				.attr("cx", function(d) {
					var proj = projection([d.Longitude, d.Latitude]);
					if (d.Latitude == "" || d.Longitude == "" || proj == null) { return;}
					return proj[0];
				})
				.attr("cy", function(d) {
					var proj = projection([d.Longitude, d.Latitude]);
					if (d.Latitude == "" || d.Longitude == "" || proj == null) { return;}
					return proj[1];
				})
				.attr("r", function(d) {
					// return Math.sqrt(d.Total_Uninjured) * 4;
					return 4;
				})
					.style("fill", "rgb(217,91,67)")
					.style("opacity", 1)

						.on("click", function(d) {
							var ttdata = ["Location: " + d.Location, "Date: " + d.Event_Date,
														"Airport Name: " + d.Airport_Name, "Registration Number: " + d.Registration_Number,
													"Model: " + d.Model, "Injury Severity: " + d.Injury_Severity];
					    	ttdiv.transition()
					      	   .duration(200)
					           .style("opacity", .9);
										 // ttdiv.text(d.Location)
										 ttdiv.html(ttdata.join('<br/>'))
		 								           .style("left", (d3.event.pageX) + "px")
		 								           .style("top", (d3.event.pageY - 28) + "px");

							 	})

    					// fade out tooltip on mouse out
				    .on("mouseout", function(d) {
				        ttdiv.transition()
				           .duration(500)
				           .style("opacity", 0);
				    });
		});


// Modified Legend Code from Mike Bostock: http://bl.ocks.org/mbostock/3888852
var legend = d3.select("body").append("svg")
      			.attr("class", "legend")
     			.attr("width", 140)
    			.attr("height", 200)
   				.selectAll("g")
   				.data(color.domain().slice().reverse())
   				.enter()
   				.append("g")
     			.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  	legend.append("rect")
   		  .attr("width", 18)
   		  .attr("height", 18)
   		  .style("fill", color);

  	legend.append("text")
  		  .data(legendText)
      	  .attr("x", 24)
      	  .attr("y", 9)
      	  .attr("dy", ".35em")
      	  .text(function(d) { return d; });
	});



//======================================================================
//======================================================================
//======================================================================

var pieData = []; //empty map {state, [Total_Fatal_Injuries,	Total_Serious_Injuries,	Total_Uninjured]}
d3.csv("aircraft_incidents.csv", function(error, data) {
		for (var i = 0; i < data.length; i++) {
			// debugger;
			// console.log(data[i]);
			if (data[i].Country != "United States") continue;
			var state = data[i].Location.slice(-2);
			var a = 0, b= 0, c = 0;
			if (data[i].Total_Fatal_Injuries != "") a = parseInt(data[i].Total_Fatal_Injuries, 10);
			if (data[i].Total_Serious_Injuries != "") b = parseInt(data[i].Total_Serious_Injuries, 10);
			if (data[i].Total_Uninjured != "") c = parseInt(data[i].Total_Uninjured, 10);
			if (state in pieData) {
					pieData[state][0]["pop"] += a;
					pieData[state][1]["pop"] += b;
					pieData[state][2]["pop"] += c;
			} else {
					var info = []
					info[0] = {};
					info[0]["label"] = "Total_Fatal_Injuries";
					info[0]["pop"] = a;
					info[1] = {}
					info[1]["label"] = "Total_Serious_Injuries";
					info[1]["pop"] = b;
					info[2] = {};
					info[2]["label"] = "Total_Uninjured";
					info[2]["pop"] = c;
					pieData[state] = info;
			}
			// console.log(pieData.state);
		}
		var pdata = pieData["GA"];
		// var psvg;
		// debugger;
		// console.log(pieData);
		var radius = Math.min(width, height) / 2;
		var pcolor = d3.scale.category20();
		// drawPie();

		// d3.selectAll("input[name='state']").on("change", function(){
    // 		pdata = pieData[this.value];
		// 		// d3.remove(psvg);
		// 		// drawPie();
		// });


		var psvg = d3.select('body')
			.append('svg')
			.attr('width', width)
			.attr('height', height)
			.append('g')
			.attr('transform', 'translate(' + (width / 2) +  ',' + (height / 2) + ')');

		var arc = d3.svg.arc()
				.innerRadius(radius - 100)
				.outerRadius(radius - 20);
		// debugger;


		var pie = d3.layout.pie()
				.value(function(d) { return d.pop; })
				.sort(null);


		// debugger;
		console.log(pdata);
		var path = psvg.selectAll('path')
				.data(pie(pdata))
				.enter()
				.append('path')
				.attr('d', arc)
				.attr('fill', function(d, i) {
					return pcolor(d.data.label);
				});

		d3.selectAll("input")
		      .on("change", change);

		  var timeout = setTimeout(function() {
		    d3.select("input[value=\"oranges\"]").property("checked", true).each(change);
		  }, 2000);


		function change() {
		    // var value = this.value;
		    clearTimeout(timeout);
		    pie.value(function(d) { return d.pop; }); // change the value function
		    path = path.data(pie(pieData[this.value])); // compute the new angles
		    path.attr("d", arc); // redraw the arcs
  	}




		// function drawPie() {
		// 			psvg = d3.select('body')
		// 			  .append('svg')
		// 			  .attr('width', width)
		// 			  .attr('height', height)
		// 			  .append('g')
		// 			  .attr('transform', 'translate(' + (width / 2) +  ',' + (height / 2) + ')');
		//
		// 			var arc = d3.svg.arc()
		// 			    .innerRadius(radius - 100)
		// 			    .outerRadius(radius - 20);
		// 			// debugger;
		//
		//
		// 			var pie = d3.layout.pie()
		// 			    .value(function(d) { return d.pop; })
		// 			    .sort(null);
		//
		//
		// 			// debugger;
		// 			console.log(pdata);
		// 			var path = psvg.selectAll('path')
		// 				  .data(pie(pdata))
		// 				  .enter()
		// 				  .append('path')
		// 				  .attr('d', arc)
		// 				  .attr('fill', function(d, i) {
		// 				    return pcolor(d.data.label);
		// 				  });
		//
		// }


})



</script>
</body>
</html>
