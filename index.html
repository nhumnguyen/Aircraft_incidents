<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3-legend/1.1.0/d3-legend.js"></script> -->
<style type="text/css">

/* On mouse hover, lighten state color */
path:hover {
	fill-opacity: .7;
}

/* Style for Custom Tooltip */
div.tooltip {
 	position: absolute;
	text-align: center;
	width: 200px;
	height: 100px;
	padding: 2px;
	font: 12px sans-serif;
	background: white;
	border: 0px;
	border-radius: 8px;
	pointer-events: none;
}


div.tooltipPie {
 	position: absolute;
	text-align: center;
	width: 100px;
	height: 30px;
	padding: 2px;
	font: 12px sans-serif;
	background: white;
	border: 0px;
	border-radius: 8px;
	pointer-events: none;
}

div.tooltipPie2 {
 	position: absolute;
	text-align: center;
	width: 150px;
	height: 30px;
	padding: 2px;
	font: 12px sans-serif;
	background: white;
	border: 0px;
	border-radius: 8px;
	pointer-events: none;
}

/* Legend Font Style */
body {
	font: 11px sans-serif;
}

/* Legend Position Style */
.legend {
	position:absolute;
	left:800px;
	top:350px;
}

</style>
</head>
<body>

<script type="text/javascript">
//Width and height of map
var width = 960;
var height = 500;

// D3 Projection
var projection = d3.geo.albersUsa()
				   .translate([width/2, height/2])    // translate to center of screen
				   .scale([1000]);          // scale things down so see entire US

// Define path generator
var path = d3.geo.path()               // path generator that will convert GeoJSON to SVG paths
		  	 .projection(projection);  // tell path generator to use albersUsa projection


// Define linear scale for output
var color = d3.scale.linear()
			  .range(["rgb(213,222,217)","rgb(69,173,168)","rgb(84,36,55)","rgb(217,91,67)"]);

var legendText = ["Cities Lived", "States Lived", "States Visited", "Nada"];

//Create SVG element and append map to the SVG
var svg = d3.select("body")
			.append("svg")
			.attr("width", width)
			.attr("height", height);

// Append Div for tooltip to SVG
var ttdiv = d3.select("body")
		    .append("div")
    		.attr("class", "tooltip")
    		.style("opacity", 0);


// var ttheader = ttdiv.append("p")
// 								.attr("class", "ttheader")
// 								.style("fill", "red");


	// Load GeoJSON data and merge with states data
d3.json("us-states.json", function(json) {
			// Find the corresponding state inside the GeoJSON
			for (var j = 0; j < json.features.length; j++)  {
								var jsonState = json.features[j].properties.name;
			}

			// Bind the data to the SVG and create one path per GeoJSON feature
			svg.selectAll("path")
				.data(json.features)
				.enter()
				.append("path")
				.attr("d", path)
				.style("stroke", "#fff")
				.style("stroke-width", "1")
				.style("fill", "darkslategray");


d3.csv("aircraft_incidents.csv", function(data) {

			svg.selectAll("circle")
				.data(data)
				.enter()
				.append("circle")
				.attr("cx", function(d) {
					var proj = projection([d.Longitude, d.Latitude]);
					if (d.Latitude == "" || d.Longitude == "" || proj == null) { return;}
					return proj[0];
				})
				.attr("cy", function(d) {
					var proj = projection([d.Longitude, d.Latitude]);
					if (d.Latitude == "" || d.Longitude == "" || proj == null) { return;}
					return proj[1];
				})
				.attr("r", function(d) {
					// return Math.sqrt(d.Total_Uninjured) * 4;
					return 4;
				})
					.style("fill", "rgb(217,91,67)")
					.style("opacity", 1)

						.on("click", function(d) {
							var ttdata = ["Location: " + d.Location, "Date: " + d.Event_Date,
														"Airport Name: " + d.Airport_Name, "Registration Number: " + d.Registration_Number,
													"Model: " + d.Model, "Injury Severity: " + d.Injury_Severity];
					    	ttdiv.transition()
					      	   .duration(200)
					           .style("opacity", .9);
										 // ttdiv.text(d.Location)
										 ttdiv.html(ttdata.join('<br/>'))
		 								           .style("left", (d3.event.pageX) + "px")
		 								           .style("top", (d3.event.pageY - 28) + "px");

							 	})

    					// fade out tooltip on mouse out
				    .on("mouseout", function(d) {
				        ttdiv.transition()
				           .duration(500)
				           .style("opacity", 0);
				    });
		});


// Modified Legend Code from Mike Bostock: http://bl.ocks.org/mbostock/3888852
var legend = d3.select("body").append("svg")
      			.attr("class", "legend")
     			.attr("width", 140)
    			.attr("height", 200)
   				.selectAll("g")
   				.data(color.domain().slice().reverse())
   				.enter()
   				.append("g")
     			.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  	legend.append("rect")
   		  .attr("width", 18)
   		  .attr("height", 18)
   		  .style("fill", color);

  	legend.append("text")
  		  .data(legendText)
      	  .attr("x", 24)
      	  .attr("y", 9)
      	  .attr("dy", ".35em")
      	  .text(function(d) { return d; });
	});



//======================================================================
//======================PIE CHART=======================================
//======================================================================
var stateAbbs = [];
var makes = []; //store the make attribute of airplanes
var pieData = []; //empty map {state, [{label: Total_Fatal_Injuries, pop: x},	{pop: Total_Serious_Injuries},	{pop: Total_Uninjured}]}
var makeData = [];
var makeMap = {};

d3.csv("aircraft_incidents.csv", function(error, data) {
		for (var i = 0; i < data.length; i++) {
			if (data[i].Country != "United States") continue;
			if (makes.indexOf(data[i].Make) > -1) continue;
			makes.push(data[i].Make);
		}
		console.log(makes);

		for (var i = 0; i < data.length; i++) {
					if (data[i].Country != "United States") continue;
					var state = data[i].Location.slice(-2);
					if (stateAbbs.indexOf(state) < 0) stateAbbs.push(state);

					// populate 1st pie chart
					var a = 0, b= 0, c = 0;
					if (data[i].Total_Fatal_Injuries != "") a = parseInt(data[i].Total_Fatal_Injuries, 10);
					if (data[i].Total_Serious_Injuries != "") b = parseInt(data[i].Total_Serious_Injuries, 10);
					if (data[i].Total_Uninjured != "") c = parseInt(data[i].Total_Uninjured, 10);
					if (state in pieData) {
							pieData[state][0]["pop"] += a;
							pieData[state][1]["pop"] += b;
							pieData[state][2]["pop"] += c;
					} else {
							var info = []
							info[0] = {};
							info[0]["label"] = "Total_Fatal_Injuries";
							info[0]["pop"] = a;
							info[1] = {}
							info[1]["label"] = "Total_Serious_Injuries";
							info[1]["pop"] = b;
							info[2] = {};
							info[2]["label"] = "Total_Uninjured";
							info[2]["pop"] = c;
							pieData[state] = info;
					}


					//initialize map for airplane's make
					var curMake = data[i].Make;
					if (state in makeMap) {
							if (!(curMake in makeMap[state])) makeMap[state][curMake] = 0;
							makeMap[state][curMake] += 1;
					} else {
						var info = {}
						info[curMake] = 1;
						makeMap[state] = info;
					}

				}

				//populate 2nd pie CHART {state, [{label: make, pop: x}, {label: make, pop: x}, {label: make, pop: x}, etc]}
				//["Bombardier", "Boeing", "McDonnell Douglas", "Embraer", "Airbus"]
				for (var s in makeMap) {
					// debugger;
					var amake = makeMap[s]; //makes of each state
					var info = [];

					for (var m in makes) { //m = {make, #};
						var temp = {};
						temp["label"] = makes[m];
						if (makes[m] in amake) {
							temp["pop"] = amake[makes[m]];
						} else {
							temp["pop"] = 0;
						}
						info.push(temp);
					}

					makeData[s] = info;
				}
				console.log(makeData);
				// debugger;

		// Create a dropdown
		var dropdown = d3.select("#makeDropdown");

		var select = dropdown.append('select')
									.attr('class','select')
									.on('change',change);

		var options = select
				.selectAll('option')
				.data(stateAbbs).enter()
				.append('option')
				.text(function (d) { return d; });

		var pdata = pieData["GA"];
		var radius = Math.min(width, height) / 2;
		var pcolor = d3.scale.category20();

		var psvg = d3.select('body')
			.append('svg')
			.attr('width', width/2)
			.attr('height', height)
			.append('g')
			.attr('transform', 'translate(' + (width / 4) +  ',' + (height / 2) + ')');

		var arc = d3.svg.arc()
				.innerRadius(radius - 150)
				.outerRadius(radius - 100);
		// debugger;


		var pie = d3.layout.pie()
				.value(function(d) { return d.pop; })
				.sort(null);


		// debugger;
		console.log(pdata);
		var path = psvg.selectAll('path')
				.data(pie(pdata))
				.enter()
				.append('path')
				.attr('d', arc)
				.attr('fill', function(d, i) {
					return pcolor(d.data.label);
				});

		  var timeout = setTimeout(function() {
		    d3.select("input[value=\"oranges\"]").property("checked", true).each(change);
		  }, 2000);


		function change() {
			// debugger;
		    var value = this.value;
		    clearTimeout(timeout);
		    pie.value(function(d) { return d.pop; }); // change the value function
				if (pieData[value] == null) return; //if no info found on this state, just not update
		    path = path.data(pie(pieData[value])); // compute the new angles
		    path.attr("d", arc); // redraw the arcs
				change2(value); //call to change 2nd pie
  	}

		// Append Div for Pie tooltip
		var ptdiv = d3.select("body")
				    .append("div")
		    		.attr("class", "tooltipPie")
		    		.style("opacity", 0);

		path.on('mouseover', function(d) {
			// debugger;
			var text = [d.data.label + ": ", d.data.pop]
			ptdiv.transition()
					 .duration(200)
					 .style("opacity", .9);
					 ptdiv.html(text.join('<br/>'))
							 .style("left", (d3.event.pageX) + "px")
							 .style("top", (d3.event.pageY - 28) + "px");
		})

		path.on('mouseout', function(d) {
			ptdiv.transition()
				 .duration(500)
				 .style("opacity", 0);
		})






		// 2nd pie chart
		var mdata = makeData["GA"];
		// var pcolor2 = {"Bombardier": #FFC0CB, "Boeing": #FFA500, "McDonnell Douglas": #6897BB, "Embraer": #BDB76B, "Airbus": #C0C0C0};
		// var pcolor2 =
		var timeout2 = setTimeout(function() {
			d3.select("input[value=\"oranges\"]").property("checked", true).each(change);
		}, 2000);
		var psvg2 = d3.select('body')
			.append('svg')
			.attr('width', width/2)
			.attr('height', height)
			.append('g')
			.attr('transform', 'translate(' + (width / 4) +  ',' + (height / 2) + ')');
			var arc2 = d3.svg.arc()
					.innerRadius(radius - 150)
					.outerRadius(radius - 100);

		var pie2 = d3.layout.pie()
				.value(function(d) { return d.pop; })
				.sort(null);

		var path2 = psvg2.selectAll('path')
				.data(pie2(mdata))
				.enter()
				.append('path')
				.attr('d', arc2)
				.attr('fill', function(d, i) {
					return pcolor(d.data.label);
				});


		function change2(value) {
			console.log(value);
			console.log(makeData[value]);
			// debugger;
		    // var value = this.value;
		    clearTimeout(timeout2);
		    pie2.value(function(d) { return d.pop; }); // change the value function
				if (makeData[value] == null) {
					console.log("no data found");
					return;
				} //if no info found on this state, just not update
				console.log(makeData[value]);
				// path2 = null;
		    path2 = path2.data(pie2(makeData[value])); // compute the new angles
		    path2.attr("d", arc2); // redraw the arcs
  	}

		// Append Div for Pie tooltip2
		var ptdiv2 = d3.select("body")
				    .append("div")
		    		.attr("class", "tooltipPie2")
		    		.style("opacity", 0);

		path2.on('mouseover', function(d) {
			// debugger;
			var text = [d.data.label + ": ", d.data.pop]
			ptdiv2.transition()
					 .duration(200)
					 .style("opacity", .9);
			ptdiv2.html(text.join('<br/>'))
					 .style("left", (d3.event.pageX) + "px")
					 .style("top", (d3.event.pageY - 28) + "px");
		})

		path2.on('mouseout', function(d) {
			ptdiv2.transition()
				 .duration(500)
				 .style("opacity", 0);
		})
})



</script>
<body>
	<h3>Please select a state</h3>
    <div id = "makeDropdown"></div>
</body>
</body>
</html>
